<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Новогодний ваншот</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: Arial, sans-serif;
            background-color: #f0f0f0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .character-sheet {
            width: 100%;
            max-width: 800px;
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 30px;
            position: relative;
            overflow: hidden;
        }
        
        /* Фоновое изображение */
        .character-sheet::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: url('FON.jpg');
            background-size: cover;
            background-position: center;
            opacity: 0.1;
            z-index: 0;
        }
        
        .sheet-content {
            position: relative;
            z-index: 1;
        }
        
        h1 {
            text-align: center;
            color: #11416e;
            margin-bottom: 30px;
            font-size: 24px;
        }
        
        .section {
            margin-bottom: 25px;
        }
        
        .avatar-section {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
            flex-wrap: wrap;
        }
        
        .avatar-container {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            overflow: hidden;
            border: 2px solid #11416e;
            background-color: #f8f8f8;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }
        
        #avatar {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }
        
        .avatar-placeholder {
            text-align: center;
            color: #666;
            padding: 20px;
            font-size: 14px;
        }
        
        .avatar-upload {
            margin-top: 10px;
        }
        
        .avatar-upload-btn {
            background-color: #11416e;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        #avatar-input {
            display: none;
        }
        
        .name-fields {
            flex: 1;
            min-width: 250px;
        }
        
        .field {
            margin-bottom: 15px;
        }
        
        .field label {
            display: block;
            margin-bottom: 5px;
            color: #11416e;
            font-weight: bold;
        }
        
        .field input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
        }
        
        .section-title {
            background-color: #11416e;
            color: white;
            padding: 10px 15px;
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        .cliche-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
        }
        
        .cliche-table td {
            padding: 10px;
            border-bottom: 1px solid #eee;
        }
        
        .cliche-name {
            width: 70%;
        }
        
        .cliche-points {
            width: 30%;
        }
        
        .cliche-table input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        
        .points-input {
            width: 80px;
            text-align: center;
        }
        
        textarea {
            width: 100%;
            padding: 15px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            min-height: 120px;
            resize: vertical;
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-top: 30px;
            justify-content: center;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
        }
        
        .save-btn {
            background-color: #11416e;
            color: white;
        }
        
        .reset-btn {
            background-color: #666;
            color: white;
        }
        
        @media (max-width: 600px) {
            .character-sheet {
                padding: 20px;
            }
            
            .avatar-section {
                flex-direction: column;
                align-items: center;
            }
            
            .name-fields {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="character-sheet" id="character-sheet">
        <div class="sheet-content">
            <h1>Лист персонажа</h1>
            
            <div class="avatar-section">
                <div>
                    <div class="avatar-container">
                        <div class="avatar-placeholder" id="avatar-placeholder">
                            Фото персонажа
                        </div>
                        <img id="avatar" src="" alt="Аватар персонажа">
                    </div>
                    <div class="avatar-upload">
                        <input type="file" id="avatar-input" accept="image/*">
                        <button class="avatar-upload-btn" id="avatar-upload-trigger">Загрузить фото</button>
                    </div>
                </div>
                
                <div class="name-fields">
                    <div class="field">
                        <label for="character-name">Имя персонажа:</label>
                        <input type="text" id="character-name" placeholder="Введите имя">
                    </div>
                    
                    <div class="field">
                        <label for="player-name">Имя игрока:</label>
                        <input type="text" id="player-name" placeholder="Введите имя">
                    </div>
                </div>
            </div>
            
            <div class="section">
                <div class="section-title">Клише</div>
                <table class="cliche-table" id="cliche-table">
                    <tbody id="cliche-tbody">
                        <!-- Строки будут добавлены скриптом -->
                    </tbody>
                </table>
            </div>
            
            <div class="section">
                <div class="section-title">Дополнительно</div>
                <textarea id="additional-info" placeholder="Дополнительная информация..."></textarea>
            </div>
            
            <div class="controls">
                <button class="btn save-btn" id="save-pdf-btn">Сохранить PDF</button>
                <button class="btn reset-btn" id="reset-btn">Сбросить</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Элементы DOM
            const avatarInput = document.getElementById('avatar-input');
            const avatarUploadTrigger = document.getElementById('avatar-upload-trigger');
            const avatar = document.getElementById('avatar');
            const avatarPlaceholder = document.getElementById('avatar-placeholder');
            const characterNameInput = document.getElementById('character-name');
            const playerNameInput = document.getElementById('player-name');
            const clicheTbody = document.getElementById('cliche-tbody');
            const additionalInfoTextarea = document.getElementById('additional-info');
            const savePdfBtn = document.getElementById('save-pdf-btn');
            const resetBtn = document.getElementById('reset-btn');
            
            // Инициализация 8 строк клише
            for (let i = 0; i < 8; i++) {
                addClicheRow();
            }
            
            // Обработчики событий
            avatarUploadTrigger.addEventListener('click', function() {
                avatarInput.click();
            });
            
            avatarInput.addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    
                    reader.onload = function(event) {
                        avatar.src = event.target.result;
                        avatar.style.display = 'block';
                        avatarPlaceholder.style.display = 'none';
                    }
                    
                    reader.readAsDataURL(e.target.files[0]);
                }
            });
            
            savePdfBtn.addEventListener('click', function() {
                saveAsPDF();
            });
            
            resetBtn.addEventListener('click', function() {
                if (confirm('Сбросить все данные?')) {
                    resetForm();
                }
            });
            
            // Функции
            function addClicheRow(name = '', points = '') {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td class="cliche-name">
                        <input type="text" class="cliche-name-input" value="${name}" placeholder="Название клише">
                    </td>
                    <td class="cliche-points">
                        <input type="number" class="points-input" value="${points}" placeholder="0" min="0">
                    </td>
                `;
                
                clicheTbody.appendChild(row);
            }
            
            async function saveAsPDF() {
                try {
                    // Временно скрываем кнопки
                    const controls = document.querySelector('.controls');
                    const originalDisplay = controls.style.display;
                    controls.style.display = 'none';
                    
                    // Создаем PDF
                    const { jsPDF } = window.jspdf;
                    const pdf = new jsPDF({
                        orientation: 'portrait',
                        unit: 'mm',
                        format: 'a4'
                    });
                    
                    // Получаем HTML-контент листа персонажа
                    const element = document.getElementById('character-sheet');
                    
                    // Создаем canvas из элемента
                    const canvas = await html2canvas(element, {
                        scale: 2,
                        useCORS: true,
                        backgroundColor: '#ffffff'
                    });
                    
                    const imgData = canvas.toDataURL('image/jpeg', 0.9);
                    
                    // Размеры A4
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    
                    // Вычисляем размеры для вписывания
                    const imgWidth = canvas.width;
                    const imgHeight = canvas.height;
                    const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight) * 0.95;
                    
                    const imgX = (pdfWidth - imgWidth * ratio) / 2;
                    const imgY = 10;
                    
                    // Добавляем изображение в PDF
                    pdf.addImage(imgData, 'JPEG', imgX, imgY, imgWidth * ratio, imgHeight * ratio);
                    
                    // Сохраняем PDF
                    const characterName = characterNameInput.value || 'персонаж';
                    pdf.save(`новогодний-ваншот-${characterName}.pdf`);
                    
                    // Восстанавливаем кнопки
                    controls.style.display = originalDisplay;
                    
                    alert('PDF сохранен!');
                    
                } catch (error) {
                    console.error('Ошибка:', error);
                    alert('Ошибка при создании PDF');
                }
            }
            
            function resetForm() {
                // Сбрасываем аватар
                avatar.src = '';
                avatar.style.display = 'none';
                avatarPlaceholder.style.display = 'flex';
                avatarInput.value = '';
                
                // Сбрасываем текстовые поля
                characterNameInput.value = '';
                playerNameInput.value = '';
                additionalInfoTextarea.value = '';
                
                // Сбрасываем таблицу клише
                const inputs = document.querySelectorAll('.cliche-name-input, .points-input');
                inputs.forEach(input => {
                    input.value = '';
                });
            }
        });
    </script>
</body>
</html>
